<div class="panel card" id="stocks-tile">
  <h2 class="section-title">Stocks</h2>
  {% if messages %}
  <div class="messages">
      {% for message in messages %}
      <div class="alert 
                  {% if message.tags %}alert-{{ message.tags }}{% endif %}">
          {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %}
    
    <div class="grid-2">
      <div>
        <!-- Search bar for stocks (moved inside the left column) -->
        <form method="get" class="search-form">
            <!-- Preserve other query parameters -->
            {% if selected_symbol %}<input type="hidden" name="symbol" value="{{ selected_symbol }}">{% endif %}
            {% if position_search %}<input type="hidden" name="position_search" value="{{ position_search }}">{% endif %}
            
            <div class="search-container">
                <input type="text" name="stock_search" value="{{ stock_search }}" 
                       placeholder="Search stocks by symbol or company name..." 
                       class="search-input">
                <button type="submit" class="search-btn">Search</button>
                {% if stock_search %}
                    <a href="?{% if selected_symbol %}symbol={{ selected_symbol }}&{% endif %}{% if position_search %}position_search={{ position_search }}{% endif %}" class="clear-search">Clear</a>
                {% endif %}
            </div>
        </form>
        
        <div class="table-scroll">
            <table class="table">
              <thead>
                <tr><th>Name</th><th>Price</th><th>Buy</th><th>Sell</th></tr>
              </thead>
              <tbody>
                {% for s in stocks %}
                <tr{% if selected_stock_symbol and selected_stock_symbol == s.symbol %} style="background:#ecfeff"{% endif %}>
                  <td><a href="?stock_symbol={{ s.symbol }}{% if selected_symbol %}&symbol={{ selected_symbol }}{% endif %}{% if position_search %}&position_search={{ position_search }}{% endif %}{% if stock_search %}&stock_search={{ stock_search }}{% endif %}">{{ s.name }} ({{ s.symbol }})</a></td>
                  <td>${{ s.latest_price|floatformat:2 }}</td>
                  <td><a href="?stock_symbol={{ s.symbol }}{% if selected_symbol %}&symbol={{ selected_symbol }}{% endif %}{% if position_search %}&position_search={{ position_search }}{% endif %}{% if stock_search %}&stock_search={{ stock_search }}{% endif %}" class="btn btn-success">Buy</a></td>
                  <td><a href="?stock_symbol={{ s.symbol }}{% if selected_symbol %}&symbol={{ selected_symbol }}{% endif %}{% if position_search %}&position_search={{ position_search }}{% endif %}{% if stock_search %}&stock_search={{ stock_search }}{% endif %}" class="btn btn-danger">Sell</a></td>
                </tr>
                {% empty %}
                <tr><td colspan="4">No symbols.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>          
      </div>
      <div><div class="chart-placeholder green">
        {% if stock_graph_data %}
          <div class="chart-header">
            <div class="chart-period-buttons">
              <button class="period-btn active">1D</button>
              <button class="period-btn disabled" disabled>1W</button>
              <button class="period-btn disabled" disabled>1M</button>
              <button class="period-btn disabled" disabled>3M</button>
              <button class="period-btn disabled" disabled>1Y</button>
            </div>
          </div>
          <canvas id="stocksChart"></canvas>
        {% else %}
          <div class="chart-message">
            <p>Select a stock to view price history</p>
          </div>
        {% endif %}
      </div></div>
    </div>
    <form method="post" class="tile-actions" action="{% url 'trade' %}">{% csrf_token %}
      <label class="mr-8"><b>Quantity:</b></label>
      <div class="quantity-controls">
        <button type="button" class="quantity-btn minus" onclick="adjustQuantity('stocks', -1)">âˆ’</button>
        <input class="input quantity-input" type="number" name="quantity" value="1" min="1" id="stocks-quantity">
        <button type="button" class="quantity-btn plus" onclick="adjustQuantity('stocks', 1)">+</button>
      </div>
      {% if selected_stock_symbol %}
      <button type="button" class="btn btn-success ml-8" onclick="showTradeModal('buy', '{{selected_stock_symbol}}', 'stocks')">Buy</button>
      <button type="button" class="btn btn-danger" onclick="showTradeModal('sell', '{{selected_stock_symbol}}', 'stocks')">Sell</button>
      {% else %}
      <button class="btn btn-success ml-8" disabled>Buy</button>
      <button class="btn btn-danger" disabled>Sell</button>
      <small class="muted">Select a stock first</small>
      {% endif %}
    </form>
  </div>

{% if stock_graph_data %}
{{ stock_graph_data|json_script:"stock-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('stocksChart');
    if (ctx) {
        const chartData = JSON.parse(document.getElementById('stock-chart-data').textContent);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: chartData.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: chartData.title + ' Price History'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price ($)'
                        }
                    },
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'MMM DD, YYYY HH:mm',
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM DD',
                                week: 'MMM DD',
                                month: 'MMM YYYY'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        ticks: {
                            maxTicksLimit: 8,
                            autoSkip: true
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
  