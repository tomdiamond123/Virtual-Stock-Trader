{% extends "brokersystem/base.html" %}
{% block content %}
<div class="container">
    <div class="dashboard-header">
      <h1 class="section-title dashboard-greeting">Hi {% if request.user.first_name %}{{ request.user.first_name }}{% else %}{{ request.user.email|truncatechars:15 }}{% endif %}</h1>
      {% if portfolio_change %}
        <p class="portfolio-status {% if portfolio_change >= 0 %}positive{% else %}negative{% endif %}">
          Your portfolio {% if portfolio_change >= 0 %}grew{% else %}declined{% endif %} {{ portfolio_change|floatformat:1 }}% today!
        </p>
      {% endif %}
    </div>
    
    <div class="stat-grid">
      <div class="stat-card">
        <h3 class="stat-label">Balance</h3>
        <p class="stat-value balance">${{ request.user.balance|floatformat:2 }}</p>
        <small class="stat-description">Cash available to trade</small>
      </div>
      <div class="stat-card">
        <h3 class="stat-label">Portfolio Value</h3>
        <p class="stat-value portfolio">${{ portfolio_amount|floatformat:2 }}</p>
        <small class="stat-description">Total holdings value</small>
      </div>
      <div class="stat-card total-worth">
        <h3 class="stat-label">Total Worth</h3>
        <p class="stat-value total">${{ total_worth|floatformat:2 }}</p>
        <small class="stat-description">Balance + Portfolio</small>
      </div>
    </div>

    <div style="height:16px"></div>

    {# positions tile reuse #}
    {% include "partials/_positions_tile.html" with positions=positions selected_symbol=selected_symbol position_graph_data=position_graph_data from_tile=from_tile %}

    <div style="height:16px"></div>

    {# stocks tile reuse (optional) #}
    {% include "partials/_stocks_tile.html" with stocks=stocks selected_stock_symbol=selected_stock_symbol stock_graph_data=stock_graph_data from_tile=from_tile %}
    </div>
  </div>

  <!-- Trade Confirmation Modal -->
  <div id="tradeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Confirm Trade</h3>
        <span class="modal-close" onclick="closeTradeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p id="modalMessage">Are you sure you want to make this trade?</p>
        <div class="trade-details">
          <div class="trade-detail">
            <span class="label">Action:</span>
            <span id="tradeAction" class="value"></span>
          </div>
          <div class="trade-detail">
            <span class="label">Stock:</span>
            <span id="tradeStock" class="value"></span>
          </div>
          <div class="trade-detail">
            <span class="label">Quantity:</span>
            <span id="tradeQuantity" class="value"></span>
          </div>
          <div class="trade-detail">
            <span class="label">Estimated Cost:</span>
            <span id="tradeCost" class="value">Calculating...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeTradeModal()">Cancel</button>
        <button type="button" id="confirmTradeBtn" class="btn btn-primary" onclick="confirmTrade()">Confirm Trade</button>
      </div>
    </div>
  </div>

  <!-- Hidden form for actual trade submission -->
  <form id="hiddenTradeForm" method="post" action="{% url 'trade' %}" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="quantity" id="hiddenQuantity">
    <input type="hidden" name="buy" id="hiddenBuy">
    <input type="hidden" name="sell" id="hiddenSell">
    <input type="hidden" name="from_positions" id="hiddenFromPositions">
  </form>
{% endblock %}