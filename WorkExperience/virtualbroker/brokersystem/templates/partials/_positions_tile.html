<div class="panel card" id="positions-tile">
    <h2 class="section-title">Positions</h2>
    
    <div class="grid-2">
      <div>
        <!-- Search bar for positions (moved inside the left column) -->
        <form method="get" class="search-form">
            <!-- Preserve other query parameters -->
            {% if selected_stock_symbol %}<input type="hidden" name="stock_symbol" value="{{ selected_stock_symbol }}">{% endif %}
            {% if stock_search %}<input type="hidden" name="stock_search" value="{{ stock_search }}">{% endif %}
            
            <div class="search-container">
                <input type="text" name="position_search" value="{{ position_search }}" 
                       placeholder="Search positions by symbol or company name..." 
                       class="search-input">
                <button type="submit" class="search-btn">Search</button>
                {% if position_search %}
                    <a href="?{% if selected_stock_symbol %}stock_symbol={{ selected_stock_symbol }}&{% endif %}{% if stock_search %}stock_search={{ stock_search }}{% endif %}" class="clear-search">Clear</a>
                {% endif %}
            </div>
        </form>
        
        <div class="table-scroll">
            <table class="table">
              <thead>
                <tr><th>Name</th><th>Total</th><th>Quantity</th><th>Price</th></tr>
              </thead>
              <tbody>
                {% for p in positions %}
                  {# turn symbol into link that sets ?symbol=...; highlight if selected #}
                  <tr{% if selected_symbol and selected_symbol == p.stock__symbol %} style="background:#ecfeff"{% endif %}>
                    <td><a href="?symbol={{ p.stock__symbol }}{% if selected_stock_symbol %}&stock_symbol={{ selected_stock_symbol }}{% endif %}{% if position_search %}&position_search={{ position_search }}{% endif %}{% if stock_search %}&stock_search={{ stock_search }}{% endif %}">{{ p.stock__name }} ({{ p.stock__symbol }})</a></td>
                    <td>${{ p.total|floatformat:0}}</td>
                    <td>{{ p.quantity }}</td>
                    <td>${{ p.price|floatformat:2 }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4">Buy some stocks to see your positions here.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>          
      </div>
        <div><div class="chart-placeholder green">
          {% if position_graph_data %}
            <div class="chart-header">
              <div class="chart-period-buttons">
                <button class="period-btn active">1D</button>
                <button class="period-btn disabled" disabled>1W</button>
                <button class="period-btn disabled" disabled>1M</button>
                <button class="period-btn disabled" disabled>3M</button>
                <button class="period-btn disabled" disabled>1Y</button>
              </div>
            </div>
            <canvas id="positionsChart"></canvas>
          {% else %}
            <div class="chart-message">
              <p>Select a position to view price history</p>
            </div>
          {% endif %}
        </div></div>
    </div>
    <form method="post" class="tile-actions" action="{% url 'trade' %}">{% csrf_token %}
      <label class="mr-8"><b>Quantity:</b></label>
      <div class="quantity-controls">
        <button type="button" class="quantity-btn minus" onclick="adjustQuantity('positions', -1)">âˆ’</button>
        <input class="input quantity-input" type="number" name="quantity" value="1" min="1" id="positions-quantity">
        <button type="button" class="quantity-btn plus" onclick="adjustQuantity('positions', 1)">+</button>
      </div>
      {% if selected_symbol %}
      <button type="button" class="btn btn-success ml-8" onclick="showTradeModal('buy', '{{selected_symbol}}', 'positions')">Buy</button>
      <button type="button" class="btn btn-danger" onclick="showTradeModal('sell', '{{selected_symbol}}', 'positions')">Sell</button>
      {% else %}
      <button class="btn btn-success ml-8" disabled>Buy</button>
      <button class="btn btn-danger" disabled>Sell</button>
      <small class="muted">Select a position first</small>
      {% endif %}
    </form>
  </div>

{% if position_graph_data %}
{{ position_graph_data|json_script:"position-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('positionsChart');
    if (ctx) {
        const chartData = JSON.parse(document.getElementById('position-chart-data').textContent);
        
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: chartData.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: chartData.title + ' Price History'
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price ($)'
                        }
                    },
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'MMM DD, YYYY HH:mm',
                            displayFormats: {
                                hour: 'HH:mm',
                                day: 'MMM DD',
                                week: 'MMM DD',
                                month: 'MMM YYYY'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        ticks: {
                            maxTicksLimit: 8,
                            autoSkip: true
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endif %}
  